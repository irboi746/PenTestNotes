# Network Recon
  * [Information Gathering](#information-gathering)
    + [DNS Recon](#dns-recon)
      - [Onilne Tools](#onilne-tools)
      - [Offline Tools](#offline-tools)
  * [Host Discovery](#host-discovery)
    + [Tools for Host Discovery](#tools-for-host-discovery)
    + [Tools for Further DNS](#tools-for-further-dns)
  * [Scanning](#scanning)
    + [Tools](#tools)

    + [References :](#references--)
  * [Service and OS Detection](#service-and-os-detection)
    + [Tools](#tools-1)
      - [DNS Check](#dns-check)
      - [Finetuning Results](#finetuning-results)
  * [Firewall / IDS Evasion](#firewall---ids-evasion)
    + [Fragmentation](#fragmentation)
    + [Decoys](#decoys)
    + [Timing](#timing)
    + [Source Port](#source-port)
  * [Enumeration](#enumeration)
  * [NETBIOS](#netbios)
    + [Tools](#tools-2)
    + [Null session](#null-session)
      - [Tools](#tools-2)
    + [SMB](#smb)
      - [Tools](#tools-3)
  * [SNMP](#snmp)
    + [Possible SNMP Attacks](#possible-snmp-attacks)
    + [Tools](#tools-4)
  * [Sniffing](#sniffing)
    + [Tools used](#tools-5)
## Information Gathering 
### DNS Recon
#### Onilne Tools
1. DNS Dumpster    
   * Online tool to do DNS information gathering.
2. Foca & Shodan

#### Offline Tools
1. NSLOOKUP
   * Enumerate Nameservers/Mail Exchange
   * for mail exchange simple change **NS** to **MX** 
   ```
   nslookup
   server <ip address>
   set q=NS
   <domain name>
   ```
   * Reverse IP lookup
   ```
   nslookup
   server <ip address>
   <domain name>
   ```
2. DIG/HOST Command
   * DIG Zone Transfer `dig @<DNS ip address> <domain name> -t AXFR +noccokie`
   * HOST Zone Transfer `host -t acfr <domain name> <DNS ip address>`
3. DNSEnum
   * A command line tools that get's host address, get name servers, get mx records, perform zone transfer queries, bruteforce subdomains
4. DNSmap
   * DNS enumeration bruteforce tool 

## Host Discovery
* Objective of Host discovery is to findout the hosts that are online to move on with the next step.
* Host discovery is a cyclical process : Host Discovery --> Further DNS

### Tools for Host Discovery
1. Fping 
   * `fping -a -g <ip address block>` 
      * `-a` shows alive host  
      * `-g` generate a target list from supplied IP netmask
2. Nmap
   * **Ping Sweep Scan** `nmap -sn --disable-arp-ping <ip range>`
      * does ping scan and disables arp scan which nmap will do
      * can consider adding `-PE` which enables ICMP echo request
   * **Disable Ping** `-Pn`
   * **TCP Scan** `nmap -n -sn -PS22,135,443,445 <ip address>`
      * -PS secifies TCP scan on specific ports
      * reason why these ranges are use is because, these few ports especially 135 is a default open port. 
### Tools for Further DNS
1. Nmap 
   * `nmap -sS -sU -p53 <ip addresses> -iL <path to text file>`
   * `nmap -sS --source-port 53 -p 53 <ip address>` 
   * DNS servers usually runs on port 53
2. DNSEnum / Dig -axfr

## Scanning 
* Objective of Scanning is to map the network within the scope of engagement and find out the Port, Protocols and Services that are running on each host.

### Tools
1. HPING / NPING
   * allow us to craft packets for host detection, port scan and evade firewall.
   #### HPING to Verify Port is Opened/Closed/Filtered
   * Scan port by port `hping3 -S -p <target port> <target Ip address>`
   * Scan port 1-1000 `hping3 <ip address> -S --scan known`
   * Look at flag : 
      1. if it is S(yn)A(ck) port is opened
      2. if it is R(st)A(ck) port is closed
      3. If there is no reply, port is filtered (firewall in between)
   * If we see '3.' We will need to consider doing Idle Scan. 
   #### HPING to conduct Idle Scan
   * 2 Criteria for zombie host are **IP ID are assigned incrementally and globally** and **zombie that does not send or receive and packets so as to not disturb the IP ID**
   1. Find open port on host
   2. Identify if host can be a Zombie Host
      * `hping3 -S -r -p <port> <ip address>`
      * Look at *id* column, if it increments by one it means that host does not send or receive other communications 
      * The above method may be too tedious as it cannot be done to a range of IP hence, nmap can be used to quicken the process.
      * `nmap -O -v -iL <ip address range>`
      * nmap report will have a **IP ID Sequence Genration : **
      * If IP ID is incremental, the host will be a good zombie.
   * The steps require two separate consoles to be opened
   3. Using hping to craft packets   
      * `hping3 -a <ip of zombie> -S -p <target port> <target IP address>` 
   4. Detecting open port
      * `hping3 -S -r -p <zombie port> <zombie>`
      * if output of IP ID is +2, we can deduce that the *target port* and *target ip address is open*
      
2.  NMAP
   #### Standard NMAP Scan
   * **Half SYN Scan** `nmap -sS -p <port range> <ip address>` 
   * **Full SYN Scan** `nmap -sT -p <port range> <ip address>`
   * **UDP Scan** `nmap -sU -p <port range> <ip address> `
   #### Stealth Methods
   * **Idle Scan** `nmap -Pn -sI <ip address zombie>:<open port on zombie> <ip address target> -v`
     * Pre-requisite  
        1. a zombie that assigns IP ID both incrementally and globally
        2. zombie that does not send or receive and packets so as to not disturb the IP ID.
     * How it works is [here](https://nmap.org/book/idlescan.html)
   #### Stealth Operators
   * **Never do DNS resolution** `mnap <ip address> -n`
      * use whenever DNS resolution is not needed to keep more stealthy and reduce scan time. 
   * **FTP bounce scan** `mnap <ip address> -b`
      *  If FTP server is vulnerable, exploits FTP servers 'PORT' command to launch port scan from FTP server
      *  Detailed explanation [here](https://nmap.org/book/scan-methods-ftp-bounce-scan.html) 
      *  Scans using this method will appear on the network to have originated from FTP server.  
   * **NULL, FIN, Xmas Scans** `-sN, -sF, -sX`
      * Explotis the TCP RFC page 65 to differentiate open ports from closed ports.
      * Hence compliant systems will return a RST if port is closed and not respond when port is opened.
      * Details [here](https://nmap.org/book/scan-methods-null-fin-xmas-scan.html) 
   #### Firewall Ruleset Enum 
   * **TCP ACK Scan** `nmap -sA <ip address>`
      * used to map the rulesets of firewalls and determine if the devices are both stateful and which ports are filtered.
      * Ports that return RST packets will be marked unfiltered while ports that do not repsond will be marked filtered.
   #### Protocol Enum 
   * **TCP Protocol Scan** `nmap -sO -p<port range> <ip address>`
      * enumerates the types of IP protocols that the target system supports.
   #### Output
   * **Normal Output** `-oN <filename>`
   * **XML output** `-oX <filename>`
### References : 
[NMAP vs MASSSCAN](https://capt-meelo.github.io//pentest/2019/07/29/port-scanning.html)

3. ARP-SCAN / netdiscover
   * Both Netdiscover and ARP-Scan uses arp
   * arp-scan `arp-scan -I <interface> <ip address range>`
   * netdiscover `netdiscover -i <interface> -r <ip address range>`

## Service and OS Detection
### Tools 
1. HPING
   #### DNS Check
   * sometimes DNS only accepts communication from port 53, communication from other ports are blocked.
   * `hping3 -S -s 53 -k -p 53 <ip address>`
   * `-s` will specify the source port and `-k` is to keep-alive the connection. 
2. NMAP
   #### Finetuning Results
   * OS fingerprinting
      * `nmap -O -v -iL <ip address list> --osscan-guess`
   * Service Detection
      * `nmap -sV <ip address>` 

## Firewall / IDS Evasion
* Four Different Techniques : 
   1. Fragmentation
   2. Decoys
   3. Timing
   4. Source Port

### Fragmentation
* Concept is to split a single packet into smaller ones, as some firewalls may not reassemble and inspect the full packets.
* **Stealth Scan** `nmap -sS -f <target IP>`
* **Connect Scan and Version Scan** `nmap -sT --mtu <offset> <target IP>` or `nmap -sV --mtu <offset> <targe IP>`
* `<offset> must be in multiples of 8` 

### Decoys
* Concept is to add noise to the IDS by sending scans from spoofed IP addresses to confuse the analyst.
* For this to work : 
   1. all decoys must be up and running
   2. IP address must appear in random order
   3. ISP traversed by spoofed traffic lets the traffic go through. 
* `nmap -sS -D <IP#1><IP#2><Own IP Address> <target>`
* Can only work on `-sS` scan

### Timing
* slowing down the scan to blend in with traffic in the Logs.
   * `-T[0~5]` to slow down the scan 
   * `--max-retries 1` to limit the number of times to resend probes.
   * example : `nmap -sS -T[0~5] --max-retries 1`

### Source Port
* used to abuse poorly configured firewall that allow traffic coming from certain ports. 
   * `--source-port <port number>` or `-g <port number>`
   * `nmap -sS `

## Enumeration
## NETBIOS
* As we know, NetBIOS allows applications on different systems to communciate with one another over LAN. As such, there is a chance for it to reveal additional information such as computer names, usernames, domains, printers, available shares etc.
* checkout Fundamentals [NetBIOS 101](https://github.com/irboi746/PenTestNotes/blob/main/Fundamentals/Network/readme.md) for more basic knowdlege of netbios

### Tools
1. nbstat (Windows)
   * Checking NetBIOS name of local machine : `nbtstat -n` 
   * Checking basic information of remote computer `nbtstat -A <target IP address>`
      * computer name, net bios suffix and domain can be obtained
      * Take note of the suffix as <20> suffix can tell use that a file or printer share is enabled.   
2. net (Windows)
   * `net view <ip address>`
      * allows us to list domains, computers and resources shared by a computer in the network.  
   * `net use <drive letter> <\\ip address\resource to connect to>`
      * used to connect or disconnect a computer from shared resource.
      * can be used to connect to remote shares that is not secured properly.
3. mount (Linux)
  * `sudo mount.cifs //<ip address>/<resource to connect to> /media/<name of mount point>/ user=,pass=`
   
4. nbtscan (Linux)
   * Checking basic information of remote computer `nbtscan -v <target IP address>` or `nbtscan -v <target IP address range>`
5. nmblookup (Linux)
   * lookup the name of the IP address in question `nmblookup -A <ip address>` and an identifier of `<20>` will show that file shares are enabled.
   * check samba version `nmblookup -V <ip address>` 
6. smblient (Linux)      
   * `smbclient -L <ip address>`
      * lists all the shares of a specific computer. 
      * hidden shares are labeled with `$` sign. 
      * `IPC$`,`C$` and `ADMIN$` are default shares.
      * there is a possibility that `IPC$` can be exploited with null session

### Null session
* Null sesion attacks relies on CIFS and SMB API to return information to an unauthenticated user.
* Malicious user can establish a connection to the Winddows system without provding any usernam and/or password.
* For it to work, connection must be established to the administrative share `IPC$`  
* This test command, `net use <\\ip address\IPC$> "" /u:""` can be used to identify if remote host is vulnerable to null session attack. 
* Afterwhich, further enumeration is to be done by other tools.
#### Tools  
1. enum4linux
   * `enum4linux <ip address>`
   * Information gathered : 
     |Password Policy|Groups| | |
     |------|------|------|------|
     |target information|workgroup/domain|domain SID|OS info|
     |Printer Info|Users|Share Enumeration|Users SID|
     
2. rpcclient    
   * This is a tool that executes Microsoft RPC functions.
   * First we must establish a connection : `rpcclient -N -U "" <target IP address>`
   * useful commands afeter connection is established ： 
     |enumalsgroups|srvinfo|lookupnames|
     |------|------|------|
     |enumprivs|queryuser|enumdomusers|
### SMB
* As we know, the existent of NetBIOS also gives a high possiblity of existence of SMB 
* For basic information on SMB, checkout SMB101 in [Fundamentals](https://github.com/irboi746/PenTestNotes/tree/main/Fundamentals/Network)
#### Tools
1. nmap 
   * nmap scripts can be run to enumerate SMB shares.
   * to list all available nmap scripts (navigate to `/use/share/nmap/script`) : `ls -l | grep -i smb`
   * Brute Forcing SMB credentials `nmap -sS <ip address> --script=<script name> -p 445`
   * SMB User Enumeration `nmap --script=smb-enum-users -p 445 <ip address> --script-args smbuser=<username>,smbpass=<password>`
   * SMB Shares Enumeration `nmap --script=smb-enum-shares -p 445 <ip address> --script-args smbuser=<username>,smbpass=<password>`

2. Metasploit
   * we can bruteforce SMB credentials with `smb_login` module
      ```
      msfconsole
      use auxiliary/scanner/smb/smb_login
      set PASS_FILE <path to password file>
      set USER_FILE <path to username file>
      set RHOSTS <ip address>
      run
      ```


## SNMP
* refer to fundamentals [SNMP 101](https://github.com/irboi746/PenTestNotes/edit/main/Fundamentals/Network/readme.md) to know what SNMP is
* The type and amount of information that can be gathered from SNMP is dependent on the commmunity string obtained, therefore it is important to know how to obtain the community string.
### Possible SNMP Attacks
1. Flooding : DOS attack which involves spoofing an SNMP agent and flooding the SNMP trap management with tens of thousands of SNMP traps, with packets of varying size until the SNMP management trap is unable to function.
2. Community : Using default community strings to gain privileged access to the system.
3. Brute Force : using a too to guess the community string used on system to do privilege escalation.

### Tools
1. Wireshark
   * Using wireshark, filter for SNMP traffic and sniff the community string. 
   * SNMPv1 and SNMPv2 uses unencrypted communications hence it will be easy to sniff for community string.
   * Wireshark filter to use : `snmp` 
2. Onesixtyone
   * Finding Community Name `onesixtyone -c /usr/share/doc/onesixtyone/dict.txt <IP address>`
3. SNMPwalk
   * enumeration `snmpwalk -v 1 -c <community name> <ip address>
4. SNMPSet
5. nmap 
   * nmap scripts can be run to do the enumeration.
   * to list all available nmap scripts (navigate to `/use/share/nmap/script`) : `ls -l | grep -i snmp`
   * General Syntax : `nmap -sU <ip address> -p 161 --script=<script name1>,<script name2>,<script name3>... `
   * To enumerate services available on target machine : `nmap -sU =p 161 --script=snmp-win32-services <ip address>`
   * Bruteforce community name 
      * Normal : `nmap -sU -<ip address> -p 161 --script=snmp-brute `, default wordlist is stored at `/usr/share/nmap/nselib/data/snmpcommunities.lst`
      * Custom word list : `nmap -sU <ip address> -p 161 --script=snmp-brute --script-args snmp-brute.communitiesdb<path to word list> `
   * Enumerate Users `nmap -sU -p161,162 --script=snmp-win32-users <ip address>`
   * Enumerate Software `nmap -sU -p161,162 --script=snmp-win32-software <ip address>`
   * Run all script with SNMP and output as text file `nmap -sU -p 161 --script snmp-* 10.10.10.5 -oG snmp.txt`

## Sniffing & MiTM
* is the act of capturing packets transmitted by other computers. 
* These packets will allow us to not only read data but also search for sensitive information transmitted.
* Sniffing is classified into two types : Passive and Active sniffing. 

### Passive Sniffing
* attacks performed by simply monitoring the network and gaining sensitive data that are transmitted (broadcasted/SPAN)

#### Tools
* Wireshark is the only tool needed.

###  Active Sniffing
* Sometimes, MiTM has to be mounted to achieve the network sniffing goals.
* MiTM (Man in the Middle) attack is where the attacker intercepts the communication between two host like a proxy where he can read, insert, modify data in the intercepted communication.    

### Tools
1. Cain & Abel
2. aaa
3. Network Miner
   * GUI tool that can analyse packets for credentials, files and images similar to Cain & Abel.
