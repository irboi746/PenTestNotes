# Network Recon
## Information Gathering 
### DNS Recon
#### Onilne Tools
1. DNS Dumpster    
   * Online tool to do DNS information gathering.
2. Foca & Shodan

#### Offline Tools
1. NSLOOKUP
   * Enumerate Nameservers/Mail Exchange
   * for mail exchange simple change **NS** to **MX** 
   ```
   nslookup
   server <ip address>
   set q=NS
   <domain name>
   ```
   * Reverse IP lookup
   ```
   nslookup
   server <ip address>
   <domain name>
   ```
2. DIG/HOST Command
   * DIG Zone Transfer `dig @<DNS ip address> <domain name> -t AXFR +noccokie`
   * HOST Zone Transfer `host -t acfr <domain name> <DNS ip address>`
3. DNSEnum
   * A command line tools that get's host address, get name servers, get mx records, perform zone transfer queries, bruteforce subdomains
4. DNSmap
   * DNS enumeration bruteforce tool 

## Host Discovery
* Objective of Host discovery is to findout the hosts that are online to move on with the next step.
* Host discovery is a cyclical process : Host Discovery --> Further DNS

### Tools for Host Discovery
1. Fping 
   * `fping -a -g <ip address block>` 
      * `-a` shows alive host  
      * `-g` generate a target list from supplied IP netmask
2. Nmap
   * **Ping Sweep Scan** `nmap -sn --disable-arp-ping <ip range>`
      * does ping scan and disables arp scan which nmap will do
      * can consider adding `-PE` which enables ICMP echo request
   * **Disable Ping** `-Pn`
   * **TCP Scan** `nmap -n -sn -PS22,135,443,445 <ip address>`
      * -PS secifies TCP scan on specific ports
      * reason why these ranges are use is because, these few ports especially 135 is a default open port. 
### Tools for Further DNS
1. Nmap 
   * `nmap -sS -sU -p53 <ip addresses> -iL <path to text file>`
   * `nmap -sS --source-port 53 -p 53 <ip address>` 
   * DNS servers usually runs on port 53
2. DNSEnum / Dig -axfr

## Scanning 
* Objective of Scanning is to map the network within the scope of engagement and find out the Port, Protocols and Services that are running on each host.

### Tools
1. HPING / NPING
   * allow us to craft packets for host detection, port scan and evade firewall.
   #### HPING to Verify Port is Opened/Closed/Filtered
   * Scan port by port `hping3 -S -p <target port> <target Ip address>`
   * Scan port 1-1000 `hping3 <ip address> -S --scan known`
   * Look at flag : 
      1. if it is S(yn)A(ck) port is opened
      2. if it is R(st)A(ck) port is closed
      3. If there is no reply, port is filtered (firewall in between)
   * If we see '3.' We will need to consider doing Idle Scan. 
   #### HPING to conduct Idle Scan
   * 2 Criteria for zombie host are **IP ID are assigned incrementally and globally** and **zombie that does not send or receive and packets so as to not disturb the IP ID**
   1. Find open port on host
   2. Identify if host can be a Zombie Host
      * `hping3 -S -r -p <port> <ip address>`
      * Look at *id* column, if it increments by one it means that host does not send or receive other communications 
      * The above method may be too tedious as it cannot be done to a range of IP hence, nmap can be used to quicken the process.
      * `nmap -O -v -iL <ip address range>`
      * nmap report will have a **IP ID Sequence Genration : **
      * If IP ID is incremental, the host will be a good zombie.
   * The steps require two separate consoles to be opened
   3. Using hping to craft packets   
      * `hping3 -a <ip of zombie> -S -p <target port> <target IP address>` 
   4. Detecting open port
      * `hping3 -S -r -p <zombie port> <zombie>`
      * if output of IP ID is +2, we can deduce that the *target port* and *target ip address is open*
      
2.  NMAP
   #### Standard NMAP Scan
   * **Half SYN Scan** `nmap -sS -p <port range> <ip address> 
   * **Full SYN Scan** `nmap -sT -p <port range> <ip address>`
   * **UDP Scan** `nmap -sU -p <port range> <ip address> `
   #### Stealth Methods
   * **Idle Scan** `nmap -Pn -sI <ip address zombie>:<open port on zombie> <ip address target> -v`
     * Pre-requisite  
        1. a zombie that assigns IP ID both incrementally and globally
        2. zombie that does not send or receive and packets so as to not disturb the IP ID.
     * How it works is [here](https://nmap.org/book/idlescan.html)
   #### Stealth Operators
   * **Never do DNS resolution** `mnap <ip address> -n`
      * use whenever DNS resolution is not needed to keep more stealthy and reduce scan time. 
   * **FTP bounce scan** `mnap <ip address> -b`
      *  If FTP server is vulnerable, exploits FTP servers 'PORT' command to launch port scan from FTP server
      *  Detailed explanation [here](https://nmap.org/book/scan-methods-ftp-bounce-scan.html) 
      *  Scans using this method will appear on the network to have originated from FTP server.  
   * **NULL, FIN, Xmas Scans** `-sN, -sF, -sX`
      * Explotis the TCP RFC page 65 to differentiate open ports from closed ports.
      * Hence compliant systems will return a RST if port is closed and not respond when port is opened.
      * Details [here](https://nmap.org/book/scan-methods-null-fin-xmas-scan.html) 
   #### Firewall Ruleset Enum 
   * **TCP ACK Scan** `nmap -sA <ip address>`
      * used to map the rulesets of firewalls and determine if the devices are both stateful and which ports are filtered.
      * Ports that return RST packets will be marked unfiltered while ports that do not repsond will be marked filtered.
   #### Protocol Enum 
   * **TCP Protocol Scan** `nmap -sO -p<port range> <ip address>`
      * enumerates the types of IP protocols that the target system supports.
   #### Output
   * **Normal Output** `-oN <filename>`
   * **XML output** `-oX <filename>`
### References : 
[NMAP vs MASSSCAN](https://capt-meelo.github.io//pentest/2019/07/29/port-scanning.html)

## Service and OS Detection
### Tools 
1. HPING
   #### DNS Check
   * sometimes DNS only accepts communication from port 53, communication from other ports are blocked.
   * `hping3 -S -s 53 -k -p 53 <ip address>`
   * `-s` will specify the source port and `-k` is to keep-alive the connection. 
2. NMAP
   #### Finetuning Results
   * OS fingerprinting
      * `nmap -O -v -iL <ip address list> --osscan-guess`
   * Service Detection
      * `nmap -sV <ip address>` 

## Firewall / IDS Evasion
* Four Different Techniques : 
   1. Fragmentation
   2. Decoys
   3. Timing
   4. Source Port

### Fragmentation
* Concept is to split a single packet into smaller ones, as some firewalls may not reassemble and inspect the full packets.
* **Stealth Scan** `nmap -sS -f <target IP>`
* **Connect Scan and Version Scan** `nmap -sT --mtu <offset> <target IP>` or `nmap -sV --mtu <offset> <targe IP>`
* `<offset> must be in multiples of 8` 

### Decoys
* Concept is to add noise to the IDS by sending scans from spoofed IP addresses to confuse the analyst.
* For this to work : 
   1. all decoys must be up and running
   2. IP address must appear in random order
   3. ISP traversed by spoofed traffic lets the traffic go through. 
* `nmap -sS -D <IP#1><IP#2><Own IP Address> <target>`
* Can only work on `-sS` scan

### Timing
* slowing down the scan to blend in with traffic in the Logs.
   * `-T[0~5]` to slow down the scan 
   * `--max-retries 1` to limit the number of times to resend probes.
   * example : `nmap -sS -T[0~5] --max-retries 1`

### Source Port
* used to abuse poorly configured firewall that allow traffic coming from certain ports. 
   * `--source-port <port number>` or `-g <port number>`
   * `nmap -sS `

## Sniffing & MiTM
### In Progress
